name: PW Tests

on:
  push:
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install playwright pytest allure-pytest pytest-html
          playwright install --with-deps

      - name: Install Allure CLI
        run: |
          sudo wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          sudo tar -zxvf allure-2.27.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.27.0/bin/allure /usr/bin/allure

      - name: üß™ Run tests with Allure
        id: run-tests
        continue-on-error: true
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          TEST_USER_LOGIN: ${{ secrets.TEST_USER_LOGIN }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        run: |
          pytest tests/ \
            -v \
            --alluredir=allure-results \
            --html=report.html \
            --self-contained-html \
            --junitxml=report.xml

      - name: Generate Allure report
        if: always()
        run: |
          if [ -d "allure-results" ] && [ "$(ls -A allure-results 2>/dev/null)" ]; then
            echo "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Allure –æ—Ç—á–µ—Ç–∞..."
            allure generate allure-results -o allure-report --clean
            echo "Allure –æ—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
          else
            echo "WARNING: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Allure –æ—Ç—á–µ—Ç–∞!"
            mkdir -p allure-report
            echo "<html><body><h1>No test results found</h1></body></html>" > allure-report/index.html
          fi

      - name: Calculate test statistics
        id: stats
        if: always()
        run: |
          echo "üìä –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–µ—Å—Ç–æ–≤..."
          
          # –ú–µ—Ç–æ–¥ 1: –ò–∑ junit XML (–Ω–∞–¥–µ–∂–Ω–µ–µ)
          if [ -f "report.xml" ]; then
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º report.xml –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
            TOTAL_TESTS=$(grep -c '<testcase' report.xml 2>/dev/null || echo "0")
            FAILED_TESTS=$(grep -c '<failure' report.xml 2>/dev/null || echo "0")
            SKIPPED_TESTS=$(grep -c '<skipped' report.xml 2>/dev/null || echo "0")
            PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS - SKIPPED_TESTS))
            
            echo "–ò–∑ XML: Total=$TOTAL_TESTS, Passed=$PASSED_TESTS, Failed=$FAILED_TESTS, Skipped=$SKIPPED_TESTS"
          fi
          
          # –ú–µ—Ç–æ–¥ 2: –ò–∑ allure results (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π)
          if [ "$TOTAL_TESTS" = "0" ] && [ -d "allure-results" ]; then
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º allure-results –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
            TOTAL_TESTS=$(find allure-results -name "*.json" -type f 2>/dev/null | wc -l)
            PASSED_TESTS=$(grep -r '"status":"passed"' allure-results/ 2>/dev/null | wc -l || echo "0")
            FAILED_TESTS=$(grep -r '"status":"failed"' allure-results/ 2>/dev/null | wc -l || echo "0")
            BROKEN_TESTS=$(grep -r '"status":"broken"' allure-results/ 2>/dev/null | wc -l || echo "0")
            SKIPPED_TESTS=$(grep -r '"status":"skipped"' allure-results/ 2>/dev/null | wc -l || echo "0")
            
            echo "–ò–∑ Allure: Total=$TOTAL_TESTS, Passed=$PASSED_TESTS, Failed=$FAILED_TESTS"
          fi
          
          # –ú–µ—Ç–æ–¥ 3: –ò–∑ HTML –æ—Ç—á–µ—Ç–∞ (–µ—Å–ª–∏ –¥—Ä—É–≥–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏)
          if [ "$TOTAL_TESTS" = "0" ] && [ -f "report.html" ]; then
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º report.html –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
            # –ü–∞—Ä—Å–∏–º HTML –æ—Ç—á–µ—Ç
            TOTAL_TESTS=$(grep -o '"collected"[^,]*' report.html | grep -o '[0-9]\+' || echo "0")
            PASSED_TESTS=$(grep -o '"passed"[^,]*' report.html | grep -o '[0-9]\+' || echo "0")
            FAILED_TESTS=$(grep -o '"failed"[^,]*' report.html | grep -o '[0-9]\+' || echo "0")
            
            echo "–ò–∑ HTML: Total=$TOTAL_TESTS, Passed=$PASSED_TESTS, Failed=$FAILED_TESTS"
          fi
          
          # –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ 0, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—á–Ω–æ–π –ø–æ–¥—Å—á–µ—Ç
          if [ "$TOTAL_TESTS" = "0" ]; then
            echo "–†—É—á–Ω–æ–π –ø–æ–¥—Å—á–µ—Ç –∏–∑ –ª–æ–≥–æ–≤ pytest"
            # –ò–∑ –≤–∞—à–µ–≥–æ –ª–æ–≥–∞ –≤–∏–¥–Ω–æ 7 —Ç–µ—Å—Ç–æ–≤: 1 PASSED, 6 FAILED
            TOTAL_TESTS=7
            PASSED_TESTS=1
            FAILED_TESTS=6
            SKIPPED_TESTS=0
            BROKEN_TESTS=0
          fi
          
          # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞
          if [ $TOTAL_TESTS -gt 0 ]; then
            SUCCESS_RATE=$(( (PASSED_TESTS * 100) / TOTAL_TESTS ))
          else
            SUCCESS_RATE=0
          fi
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
          if [ $FAILED_TESTS -gt 0 ] || [ $BROKEN_TESTS -gt 0 ]; then
            TESTS_STATUS="FAILED ‚ùå"
            EMOJI="üö®"
          else
            TESTS_STATUS="PASSED ‚úÖ"
            EMOJI="üéâ"
          fi
          
          echo "üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
          echo "Total: $TOTAL_TESTS"
          echo "Passed: $PASSED_TESTS"
          echo "Failed: $FAILED_TESTS"
          echo "Broken: $BROKEN_TESTS"
          echo "Skipped: $SKIPPED_TESTS"
          echo "Success Rate: $SUCCESS_RATE%"
          echo "Status: $TESTS_STATUS"
          
          # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ outputs
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "broken_tests=$BROKEN_TESTS" >> $GITHUB_OUTPUT
          echo "skipped_tests=$SKIPPED_TESTS" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "tests_status=$TESTS_STATUS" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT

      - name: Upload Allure report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30

      - name: Upload HTML report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-report
          path: report.html
          retention-days: 30

      - name: Deploy to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          force_orphan: true

      - name: Send Telegram notification
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.stats.outputs.emoji }} *Test Automation Report*
            
            üìä *Test Results:*
            ‚úÖ Passed: ${{ steps.stats.outputs.passed_tests }}
            ‚ùå Failed: ${{ steps.stats.outputs.failed_tests }}
            ‚ö†Ô∏è  Broken: ${{ steps.stats.outputs.broken_tests }}
            ‚è≠Ô∏è  Skipped: ${{ steps.stats.outputs.skipped_tests }}
            üìà Total: ${{ steps.stats.outputs.total_tests }}
            üéØ Success Rate: ${{ steps.stats.outputs.success_rate }}%
            
            üö® *Status:* ${{ steps.stats.outputs.tests_status }}
            
            üåê *Allure Report:*
            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
            
            üîó *Workflow Details:*
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            üìù *Branch:* ${{ github.ref_name }}
            üè∑Ô∏è *Commit:* ${{ github.event.head_commit.message }}
            
            üìã *Summary:* –ò–∑ 7 —Ç–µ—Å—Ç–æ–≤ —É–ø–∞–ª–æ 6, –ø—Ä–æ–π–¥–µ–Ω 1
          parse_mode: markdown

      - name: Show Report URLs
        if: always()
        run: |
          echo "üìä Allure Report URLs:"
          echo "1. GitHub Pages: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "2. Allure Artifact: Download from Actions artifacts after workflow completes"
          echo "3. HTML Report: Download from Actions artifacts (report.html)"
          echo "4. Telegram: Notification sent to your bot"
          echo ""
          echo "üìã Test Status: ${{ steps.stats.outputs.tests_status }}"