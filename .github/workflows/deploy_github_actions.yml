name: PW Tests

on:
  push:
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install playwright pytest allure-pytest pytest-html
          playwright install --with-deps

      - name: Install Allure CLI
        run: |
          sudo wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          sudo tar -zxvf allure-2.27.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.27.0/bin/allure /usr/bin/allure

      - name: üß™ Run tests with Allure
        id: run-tests
        continue-on-error: true
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          TEST_USER_LOGIN: ${{ secrets.TEST_USER_LOGIN }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        run: |
          # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–µ—Å—Ç–æ–≤
          echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–∫–∏ tests:"
          find tests/ -type f -name "*.py" | head -20
          
          echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º allure-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          pytest tests/ \
            -v \
            --alluredir=allure-results \
            --html=report.html \
            --self-contained-html \
            --junitxml=report.xml
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–∑–¥–∞–ª–∏—Å—å –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:"
          if [ -d "allure-results" ]; then
            echo "Allure results —Å–æ–∑–¥–∞–Ω—ã"
            ls -la allure-results/ | head -10
          else
            echo "ERROR: Allure results –ù–ï —Å–æ–∑–¥–∞–Ω—ã!"
          fi

      - name: Generate Allure report
        if: always()
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
          if [ -d "allure-results" ] && [ "$(ls -A allure-results)" ]; then
            echo "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Allure –æ—Ç—á–µ—Ç–∞..."
            allure generate allure-results -o allure-report --clean
            echo "Allure –æ—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
          else
            echo "WARNING: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Allure –æ—Ç—á–µ—Ç–∞!"
            mkdir -p allure-report
            echo "<html><body><h1>No test results found</h1></body></html>" > allure-report/index.html
          fi

      - name: Calculate test statistics
        id: stats
        if: always()
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          if [ -d "allure-results" ] && [ "$(ls -A allure-results 2>/dev/null)" ]; then
            echo "üìä –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–∑ allure-results..."
            TOTAL_TESTS=$(find allure-results -name "*.json" | wc -l)
            PASSED_TESTS=$(grep -r '"status":"passed"' allure-results/*.json 2>/dev/null | wc -l || echo "0")
            FAILED_TESTS=$(grep -r '"status":"failed"' allure-results/*.json 2>/dev/null | wc -l || echo "0")
            BROKEN_TESTS=$(grep -r '"status":"broken"' allure-results/*.json 2>/dev/null | wc -l || echo "0")
            SKIPPED_TESTS=$(grep -r '"status":"skipped"' allure-results/*.json 2>/dev/null | wc -l || echo "0")
            
            echo "Found: Total=$TOTAL_TESTS, Passed=$PASSED_TESTS, Failed=$FAILED_TESTS"
          else
            echo "‚ö†Ô∏è  Allure results –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–æ–≤–µ—Ä—è–µ–º junit xml..."
            if [ -f "report.xml" ]; then
              TOTAL_TESTS=$(grep -c '<testcase' report.xml 2>/dev/null || echo "0")
              PASSED_TESTS=$(grep -c '<testcase' report.xml 2>/dev/null || echo