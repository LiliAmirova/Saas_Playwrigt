name: PW Tests

on:
  push:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
  schedule:
    # Ğ—Ğ°Ğ¿ÑƒÑĞº ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² 17:30 Ğ¿Ğ¾ ĞœĞ¾ÑĞºĞ²Ğµ (14:30 UTC)
    - cron: '05 17 * * *'

jobs:
  run-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install playwright pytest allure-pytest
          playwright install --with-deps

      - name: Install Allure CLI
        run: |
          sudo wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          sudo tar -zxvf allure-2.27.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.27.0/bin/allure /usr/bin/allure

      - name: ğŸ§ª Run tests with Allure
        id: run-tests
        continue-on-error: true
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          TEST_USER_LOGIN: ${{ secrets.TEST_USER_LOGIN }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        run: |
          pytest tests/ -v --alluredir=allure-results

      - name: Generate Allure report
        if: always()
        run: |
          allure generate allure-results -o allure-report --clean

      - name: Check allure-results directory
        if: always()
        run: |
          echo "Checking allure-results directory..."
          ls -la allure-results/ || echo "Directory allure-results not found"
          find allure-results -type f -name "*.json" | wc -l
          

      - name: Calculate test statistics
        id: stats
        if: always()
        run: |
            TOTAL_TESTS=$(find allure-results -name "*.json" 2>/dev/null | wc -l || echo "0")
            PASSED_TESTS=$(grep -r '"status":"passed"' allure-results/*.json 2>/dev/null | wc -l || echo "0")
            
            # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ñ„Ğ°Ğ¹Ğ»
            echo "TOTAL_TESTS=$TOTAL_TESTS" >> stats.env
            echo "PASSED_TESTS=$PASSED_TESTS" >> stats.env
            echo "FAILED_TESTS=$FAILED_TESTS" >> stats.env
            
            # Ğ¢Ğ°ĞºĞ¶Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² GITHUB_OUTPUT
            echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
            echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
            
            # Ğ’Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ°
            cat stats.env

            - name: Load stats to env
              if: always()
              run: |
                # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ°
                if [ -f stats.env ]; then
                  set -a
                  source stats.env
                  set +a
                  echo "Loaded stats from file"
                else
                  echo "stats.env not found, using defaults"
                  export TOTAL_TESTS=0
                  export PASSED_TESTS=0
                fi

            - name: Send Telegram notification
              if: always()
              env:
                TOTAL_TESTS_ENV: ${{ env.TOTAL_TESTS || '0' }}
                PASSED_TESTS_ENV: ${{ env.PASSED_TESTS || '0' }}
              uses: appleboy/telegram-action@master
              with:
                to: ${{ secrets.TELEGRAM_CHAT_ID }}
                token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
                message: |
                  Using env variables:
                  âœ… Passed: ${{ env.PASSED_TESTS_ENV }}
                  ğŸ“Š Total: ${{ env.TOTAL_TESTS_ENV }}

      - name: Upload Allure report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30

      - name: Deploy to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          force_orphan: true

      - name: Send Telegram notification
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.stats.outputs.status_emoji }}  Daily Test Report 
            
            ğŸ“‹ Run Type: ${{ steps.stats.outputs.run_type }}
            ğŸ“Š Status: ${{ steps.stats.outputs.run_status }}
            
            ğŸ“ˆ Test Results:
               âœ…  Passed: ${{ steps.stats.outputs.passed_tests }}
               âŒ  Failed: ${{ steps.stats.outputs.failed_tests }}
               âš ï¸  Broken: ${{ steps.stats.outputs.broken_tests }}
               â­ï¸  Skipped: ${{ steps.stats.outputs.skipped_tests }}
               ğŸ“Š  Total: ${{ steps.stats.outputs.total_tests }}
               ğŸ¯  Success Rate: ${{ steps.stats.outputs.success_rate }}%
            
            ğŸŒ  Allure Report:
            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
            
            ğŸ”— Workflow Details:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ğŸ“ Branch: ${{ github.ref_name }}
            ğŸ·ï¸ Commit: ${{ github.event.head_commit.message }}
          parse_mode: markdown

      - name: Show Report URLs
        if: always()
        run: |
          echo "ğŸ“Š Allure Report URLs:"
          echo "1. GitHub Pages: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "2. Artifact: Download from Actions artifacts after workflow completes"
          echo "3. Telegram: Notification sent to your bot"
          echo ""
          echo "ğŸ“‹ Run Status: ${{ steps.stats.outputs.run_status }}"
          echo "ğŸƒ Run Type: ${{ steps.stats.outputs.run_type }}"