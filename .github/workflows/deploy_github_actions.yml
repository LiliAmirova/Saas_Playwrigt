name: Test Execution and Reporting

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test-and-report:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up environment
      run: |
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–ª–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        echo "Setting up environment..."

    - name: Run tests
      id: run_tests
      run: |
        # –ó–¥–µ—Å—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
        # –ü—Ä–∏–º–µ—Ä: npm test, pytest, mvn test –∏ —Ç.–¥.
        echo "Running tests..."
        
        # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤)
        TOTAL_TESTS=150
        PASSED_TESTS=140
        FAILED_TESTS=5
        BROKEN_TESTS=3
        SKIPPED_TESTS=2
        
        # –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —É—Å–ø–µ—Ö–∞
        if [ "$TOTAL_TESTS" -gt 0 ]; then
          SUCCESS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
        else
          SUCCESS_RATE=0
        fi
        
        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        if [ "$FAILED_TESTS" -eq 0 ] && [ "$BROKEN_TESTS" -eq 0 ]; then
          TESTS_STATUS="‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
          EMOJI="‚úÖ"
        elif [ "$FAILED_TESTS" -gt 0 ]; then
          TESTS_STATUS="‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ—É–¥–∞—á–Ω—ã–µ —Ç–µ—Å—Ç—ã"
          EMOJI="‚ùå"
        elif [ "$BROKEN_TESTS" -gt 0 ]; then
          TESTS_STATUS="‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å–ª–æ–º–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã"
          EMOJI="‚ö†Ô∏è"
        else
          TESTS_STATUS="‚ÑπÔ∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
          EMOJI="‚ÑπÔ∏è"
        fi
        
        # –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        echo "–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: $TOTAL_TESTS"
        echo "–ü—Ä–æ–π–¥–µ–Ω–æ: $PASSED_TESTS"
        echo "–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ: $FAILED_TESTS"
        echo "–°–ª–æ–º–∞–Ω–æ: $BROKEN_TESTS"
        echo "–ü—Ä–æ–ø—É—â–µ–Ω–æ: $SKIPPED_TESTS"
        echo "–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞: $SUCCESS_RATE%"
        echo "–°—Ç–∞—Ç—É—Å: $TESTS_STATUS"
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –≤—ã—Ö–æ–¥—ã
        echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
        echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
        echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
        echo "broken_tests=$BROKEN_TESTS" >> $GITHUB_OUTPUT
        echo "skipped_tests=$SKIPPED_TESTS" >> $GITHUB_OUTPUT
        echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
        echo "tests_status=$TESTS_STATUS" >> $GITHUB_OUTPUT
        echo "emoji=$EMOJI" >> $GITHUB_OUTPUT

    - name: Create Telegram message
      env:
        TOTAL_TESTS: ${{ steps.run_tests.outputs.total_tests }}
        PASSED_TESTS: ${{ steps.run_tests.outputs.passed_tests }}
        FAILED_TESTS: ${{ steps.run_tests.outputs.failed_tests }}
        BROKEN_TESTS: ${{ steps.run_tests.outputs.broken_tests }}
        SKIPPED_TESTS: ${{ steps.run_tests.outputs.skipped_tests }}
        SUCCESS_RATE: ${{ steps.run_tests.outputs.success_rate }}
        TESTS_STATUS: ${{ steps.run_tests.outputs.tests_status }}
        EMOJI: ${{ steps.run_tests.outputs.emoji }}
      run: |
        TELEGRAM_MESSAGE="$EMOJI *–û—Ç—á–µ—Ç –æ–± –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è*

‚ùëÔ∏è *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞:*

‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ: $PASSED_TESTS
‚ùå –ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ: $FAILED_TESTS
‚ö†Ô∏è –°–ª–æ–º–∞–Ω–æ: $BROKEN_TESTS
‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ: $SKIPPED_TESTS
üìä –ò—Ç–æ–≥–æ: $TOTAL_TESTS
üíØ –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞: $SUCCESS_RATE%

‚úÖ *–°—Ç–∞—Ç—É—Å:* $TESTS_STATUS

‚ùëÔ∏è *–û—Ç—á–µ—Ç –æ–± –æ—á–∞—Ä–æ–≤–∞–Ω–∏–∏:*
https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY#*/}

üîó *–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞:*
https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}

üåø *–í–µ—Ç–∫–∞:* ${GITHUB_REF_NAME}
üìù *–ö–æ–º–º–∏—Ç:* ${GITHUB_EVENT_HEAD_COMMIT_MESSAGE}"

        # –ï—Å–ª–∏ —Ç–µ—Å—Ç–æ–≤ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        if [ "$TOTAL_TESTS" -eq "0" ]; then
          TELEGRAM_MESSAGE="$TELEGRAM_MESSAGE

‚ö†Ô∏è *–í–Ω–∏–º–∞–Ω–∏–µ:* –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è!"
        fi
        
        echo "$TELEGRAM_MESSAGE" > telegram_message.txt
        echo "Telegram message created"
        cat telegram_message.txt
    
    - name: Send Telegram notification
      if: always()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run:|
        if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
          echo "Telegram credentials not set. Skipping notification."
          exit 0
        fi
        
        MESSAGE=$(cat telegram_message.txt | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
        
        curl -s -X POST \
          -H "Content-Type: application/json" \
          -d "{\"chat_id\":\"$TELEGRAM_CHAT_ID\",\"text\":\"$MESSAGE\",\"parse_mode\":\"Markdown\"}" \
          https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage
        
        echo "Telegram notification sent"

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: |
          telegram_message.txt
          # –î–æ–±–∞–≤—å—Ç–µ –∑–¥–µ—Å—å –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–æ–≤
        retention-days: 30