name: PW Tests

on:
  push:
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install playwright pytest allure-pytest
          playwright install --with-deps

      - name: Install Allure CLI
        run: |
          sudo wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          sudo tar -zxvf allure-2.27.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.27.0/bin/allure /usr/bin/allure

      - name: ğŸ§ª Run tests with Allure
        id: run-tests
        continue-on-error: true  # ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ñ‚ĞµÑÑ‚Ñ‹ ÑƒĞ¿Ğ°Ğ»Ğ¸
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          TEST_USER_LOGIN: ${{ secrets.TEST_USER_LOGIN }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        run: |
          pytest tests/ -v --alluredir=allure-results

      - name: Generate Allure report
        if: always()  # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ñ‚ĞµÑÑ‚Ñ‹ ÑƒĞ¿Ğ°Ğ»Ğ¸
        run: |
          allure generate allure-results -o allure-report --clean

      - name: Calculate test statistics
        id: stats
        if: always()  # Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ñ‚ĞµÑÑ‚Ñ‹ ÑƒĞ¿Ğ°Ğ»Ğ¸
        run: |
          TOTAL_TESTS=$(find allure-results -name "*.json" | wc -l)
          PASSED_TESTS=$(grep -r '"status":"passed"' allure-results/*.json 2>/dev/null | wc -l || echo "0")
          FAILED_TESTS=$(grep -r '"status":"failed"' allure-results/*.json 2>/dev/null | wc -l || echo "0")
          BROKEN_TESTS=$(grep -r '"status":"broken"' allure-results/*.json 2>/dev/null | wc -l || echo "0")
          SKIPPED_TESTS=$(grep -r '"status":"skipped"' allure-results/*.json 2>/dev/null | wc -l || echo "0")
          
          if [ $TOTAL_TESTS -gt 0 ]; then
            SUCCESS_RATE=$(( (PASSED_TESTS * 100) / TOTAL_TESTS ))
          else
            SUCCESS_RATE=0
          fi
          
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "broken_tests=$BROKEN_TESTS" >> $GITHUB_OUTPUT
          echo "skipped_tests=$SKIPPED_TESTS" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          
          # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ²
          if [ $FAILED_TESTS -gt 0 ] || [ $BROKEN_TESTS -gt 0 ]; then
            echo "tests_status=FAILED âŒ" >> $GITHUB_OUTPUT
          else
            echo "tests_status=PASSED âœ…" >> $GITHUB_OUTPUT
          fi

      - name: Upload Allure report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30

      - name: Deploy to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          force_orphan: true

      - name: Send Telegram notification
        if: always()  # ĞšĞ»ÑÑ‡ĞµĞ²Ğ¾Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ - Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ’Ğ¡Ğ•Ğ“Ğ”Ğ
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.stats.outputs.tests_status == 'PASSED âœ…' && 'ğŸ‰' || 'ğŸš¨' }} *Test Automation Report*
            
            ğŸ“Š *Test Results:*
            âœ… Passed: ${{ steps.stats.outputs.passed_tests }}
            âŒ Failed: ${{ steps.stats.outputs.failed_tests }}
            âš ï¸  Broken: ${{ steps.stats.outputs.broken_tests }}
            â­ï¸  Skipped: ${{ steps.stats.outputs.skipped_tests }}
            ğŸ“ˆ Total: ${{ steps.stats.outputs.total_tests }}
            ğŸ¯ Success Rate: ${{ steps.stats.outputs.success_rate }}%
            
            ğŸš¨ *Status:* ${{ steps.stats.outputs.tests_status }}
            
            ğŸŒ *Allure Report:*
            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
            
            ğŸ”— *Workflow Details:*
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ğŸ“ *Branch:* ${{ github.ref_name }}
            ğŸ·ï¸ *Commit:* ${{ github.event.head_commit.message }}
          parse_mode: markdown

      - name: Show Report URLs
        if: always()
        run: |
          echo "ğŸ“Š Allure Report URLs:"
          echo "1. GitHub Pages: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "2. Artifact: Download from Actions artifacts after workflow completes"
          echo "3. Telegram: Notification sent to your bot"
          echo ""
          echo "ğŸ“‹ Test Status: ${{ steps.stats.outputs.tests_status }}"