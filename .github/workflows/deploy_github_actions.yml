name: PW Tests

on:
  push:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
  schedule:
    # Ğ—Ğ°Ğ¿ÑƒÑĞº ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² 17:30 Ğ¿Ğ¾ ĞœĞ¾ÑĞºĞ²Ğµ (14:30 UTC)
    - cron: '05 17 * * *'

jobs:
  run-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:

      # Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ•: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ GitHub Ğ² known_hosts Ğ´Ğ»Ñ SSH
      - name: Setup SSH for GitHub
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -t ed25519 github.com >> ~/.ssh/known_hosts
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Check out repository code
        uses: actions/checkout@v4


      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install playwright pytest allure-pytest
          playwright install --with-deps

      - name: Install Allure CLI
        run: |
          sudo wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          sudo tar -zxvf allure-2.27.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.27.0/bin/allure /usr/bin/allure

      - name: ğŸ§ª Run tests with Allure
        id: run-tests
        continue-on-error: true
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          TEST_USER_LOGIN: ${{ secrets.TEST_USER_LOGIN }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        run: |
          pytest tests/ -v --alluredir=allure-results

      - name: Generate Allure report
        if: always()
        run: |
          allure generate allure-results -o allure-report --clean

      - name: Calculate test statistics
        id: stats
        if: always()
        run: |
          TOTAL_TESTS=$(find allure-results -name "*.json" | wc -l)
          PASSED_TESTS=$(grep -r '"status":"passed"' allure-results/*.json 2>/dev/null | wc -l || echo "0")
          FAILED_TESTS=$(grep -r '"status":"failed"' allure-results/*.json 2>/dev/null | wc -l || echo "0")
          BROKEN_TESTS=$(grep -r '"status":"broken"' allure-results/*.json 2>/dev/null | wc -l || echo "0")
          SKIPPED_TESTS=$(grep -r '"status":"skipped"' allure-results/*.json 2>/dev/null | wc -l || echo "0")
          
          # ĞÑ‚Ğ»Ğ°Ğ´Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´
          echo "DEBUG: Total test files: $TOTAL_TESTS"
          echo "DEBUG: Passed: $PASSED_TESTS, Failed: $FAILED_TESTS, Broken: $BROKEN_TESTS, Skipped: $SKIPPED_TESTS"
          
          if [ $TOTAL_TESTS -gt 0 ]; then
            SUCCESS_RATE=$(( (PASSED_TESTS * 100) / TOTAL_TESTS ))
          else
            SUCCESS_RATE=0
          fi
          
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ‚Ğ¸Ğ¿ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            RUN_TYPE="ğŸ•” Daily Run (17:30 MSK)"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            RUN_TYPE="ğŸ‘¨â€ğŸ’» Manual Run"
          else
            RUN_TYPE="ğŸš€ Push Run"
          fi
          
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ emoji Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° (Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Telegram)
          if [ $FAILED_TESTS -gt 0 ] || [ $BROKEN_TESTS -gt 0 ]; then
            RUN_STATUS="FAILED âŒ"
            STATUS_EMOJI="ğŸš¨"
          else
            RUN_STATUS="PASSED âœ…"
            STATUS_EMOJI="ğŸ‰"
          fi
          
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "broken_tests=$BROKEN_TESTS" >> $GITHUB_OUTPUT
          echo "skipped_tests=$SKIPPED_TESTS" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "run_type=$RUN_TYPE" >> $GITHUB_OUTPUT
          echo "run_status=$RUN_STATUS" >> $GITHUB_OUTPUT
          echo "status_emoji=$STATUS_EMOJI" >> $GITHUB_OUTPUT

      - name: Upload Allure report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30

      - name: Deploy to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          force_orphan: true

      - name: Send Telegram notification
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ steps.stats.outputs.status_emoji }} *Daily Test Report*
            
            ğŸ“‹ Run Type: ${{ steps.stats.outputs.run_type }}
            ğŸ“Š Status: ${{ steps.stats.outputs.run_status }}
            
            ğŸ“ˆ Test Results:
            âœ… Passed: ${{ steps.stats.outputs.passed_tests }}
            âŒ Failed: ${{ steps.stats.outputs.failed_tests }}
            âš ï¸ Broken: ${{ steps.stats.outputs.broken_tests }}
            â­ï¸ Skipped: ${{ steps.stats.outputs.skipped_tests }}
            ğŸ“Š Total: ${{ steps.stats.outputs.total_tests }}
            ğŸ¯ Success Rate: ${{ steps.stats.outputs.success_rate }}%
            
            ğŸŒ Allure Report:
            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
            
            ğŸ”— Workflow Details:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ğŸ“ Branch: ${{ github.ref_name }}
            ğŸ·ï¸ Commit: ${{ github.event.head_commit.message }}
          parse_mode: markdown

      - name: Show Report URLs
        if: always()
        run: |
          echo "ğŸ“Š Allure Report URLs:"
          echo "1. GitHub Pages: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "2. Artifact: Download from Actions artifacts after workflow completes"
          echo "3. Telegram: Notification sent to your bot"
          echo ""
          echo "ğŸ“‹ Run Status: ${{ steps.stats.outputs.run_status }}"
          echo "ğŸƒ Run Type: ${{ steps.stats.outputs.run_type }}"