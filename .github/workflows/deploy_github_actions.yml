name: PW Tests

on:
  push:
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install playwright pytest allure-pytest pytest-html
          playwright install --with-deps

      - name: Install Allure CLI
        run: |
          sudo wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          sudo tar -zxvf allure-2.27.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.27.0/bin/allure /usr/bin/allure

      - name: üß™ Run tests with Allure
        id: run-tests
        continue-on-error: true
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          TEST_USER_LOGIN: ${{ secrets.TEST_USER_LOGIN }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        run: |
          pytest tests/ \
            -v \
            --alluredir=allure-results \
            --html=report.html \
            --self-contained-html \
            --junitxml=report.xml

      - name: Generate Allure report
        if: always()
        run: |
          if [ -d "allure-results" ] && [ "$(ls -A allure-results 2>/dev/null)" ]; then
            echo "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Allure –æ—Ç—á–µ—Ç–∞..."
            allure generate allure-results -o allure-report --clean
            echo "Allure –æ—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
          else
            echo "WARNING: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Allure –æ—Ç—á–µ—Ç–∞!"
            mkdir -p allure-report
            echo "<html><body><h1>No test results found</h1></body></html>" > allure-report/index.html
          fi

      - name: Calculate test statistics and prepare message
        id: stats
        if: always()
        run: |
          echo "üìä –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–µ—Å—Ç–æ–≤..."
          
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          TOTAL_TESTS=0
          PASSED_TESTS=0
          FAILED_TESTS=0
          BROKEN_TESTS=0
          SKIPPED_TESTS=0
          SUCCESS_RATE=0
          TESTS_STATUS="UNKNOWN"
          EMOJI="‚ùì"
          
          # –ú–µ—Ç–æ–¥ 1: –ò–∑ junit XML (–Ω–∞–¥–µ–∂–Ω–µ–µ)
          if [ -f "report.xml" ]; then
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º report.xml –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
            TOTAL_TESTS=$(grep -c '<testcase' report.xml 2>/dev/null || echo "0")
            FAILED_TESTS=$(grep -c '<failure' report.xml 2>/dev/null || echo "0")
            SKIPPED_TESTS=$(grep -c '<skipped' report.xml 2>/dev/null || echo "0")
            PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS - SKIPPED_TESTS))
            
            echo "–ò–∑ XML: Total=$TOTAL_TESTS, Passed=$PASSED_TESTS, Failed=$FAILED_TESTS, Skipped=$SKIPPED_TESTS"
          fi
          
          # –ú–µ—Ç–æ–¥ 2: –ò–∑ allure results (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π)
          if [ "$TOTAL_TESTS" = "0" ] && [ -d "allure-results" ]; then
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º allure-results –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
            TOTAL_TESTS=$(find allure-results -name "*.json" -type f 2>/dev/null | wc -l)
            PASSED_TESTS=$(grep -r '"status":"passed"' allure-results/ 2>/dev/null | wc -l || echo "0")
            FAILED_TESTS=$(grep -r '"status":"failed"' allure-results/ 2>/dev/null | wc -l || echo "0")
            BROKEN_TESTS=$(grep -r '"status":"broken"' allure-results/ 2>/dev/null | wc -l || echo "0")
            SKIPPED_TESTS=$(grep -r '"status":"skipped"' allure-results/ 2>/dev/null | wc -l || echo "0")
            
            echo "–ò–∑ Allure: Total=$TOTAL_TESTS, Passed=$PASSED_TESTS, Failed=$FAILED_TESTS"
          fi
          
          # –ú–µ—Ç–æ–¥ 3: –ò–∑ HTML –æ—Ç—á–µ—Ç–∞
          if [ "$TOTAL_TESTS" = "0" ] && [ -f "report.html" ]; then
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º report.html –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
            TOTAL_TESTS=$(grep -o '"collected"[^,]*' report.html | grep -o '[0-9]\+' || echo "0")
            PASSED_TESTS=$(grep -o '"passed"[^,]*' report.html | grep -o '[0-9]\+' || echo "0")
            FAILED_TESTS=$(grep -o '"failed"[^,]*' report.html | grep -o '[0-9]\+' || echo "0")
            
            echo "–ò–∑ HTML: Total=$TOTAL_TESTS, Passed=$PASSED_TESTS, Failed=$FAILED_TESTS"
          fi
          
          # –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∏ –≤ –æ–¥–Ω–æ–º –æ—Ç—á–µ—Ç–µ
          if [ "$TOTAL_TESTS" = "0" ]; then
            echo "‚ö†Ô∏è  –¢–µ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –æ—Ç—á–µ—Ç–∞—Ö!"
            echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
            echo "1. –¢–µ—Å—Ç—ã –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å"
            echo "2. –û—Ç—á–µ—Ç—ã –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å"
            echo "3. –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –≤ –ø–∞–ø–∫–µ tests/"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–µ—Å—Ç—ã –≤ –ø–∞–ø–∫–µ
            TEST_FILES_COUNT=$(find tests/ -name "*.py" -type f 2>/dev/null | wc -l)
            echo "–§–∞–π–ª–æ–≤ —Ç–µ—Å—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ: $TEST_FILES_COUNT"
          fi
          
          # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞
          if [ $TOTAL_TESTS -gt 0 ]; then
            SUCCESS_RATE=$(( (PASSED_TESTS * 100) / TOTAL_TESTS ))
          else
            SUCCESS_RATE=0
          fi
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
          if [ $TOTAL_TESTS -eq 0 ]; then
            TESTS_STATUS="NO TESTS ‚ö†Ô∏è"
            EMOJI="‚ùì"
          elif [ $FAILED_TESTS -gt 0 ] || [ $BROKEN_TESTS -gt 0 ]; then
            TESTS_STATUS="FAILED ‚ùå"
            EMOJI="üö®"
          else
            TESTS_STATUS="PASSED ‚úÖ"
            EMOJI="üéâ"
          fi
          
          echo "üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
          echo "Total: $TOTAL_TESTS"
          echo "Passed: $PASSED_TESTS"
          echo "Failed: $FAILED_TESTS"
          echo "Broken: $BROKEN_TESTS"
          echo "Skipped: $SKIPPED_TESTS"
          echo "Success Rate: $SUCCESS_RATE%"
          echo "Status: $TESTS_STATUS"
          
          # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ outputs
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "broken_tests=$BROKEN_TESTS" >> $GITHUB_OUTPUT
          echo "skipped_tests=$SKIPPED_TESTS" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "tests_status=$TESTS_STATUS" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          
          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –¥–ª—è Telegram
          TELEGRAM_MESSAGE="$EMOJI *Test Automation Report*

          üìä *Test Results:*
         ‚úÖ Passed: $PASSED_TESTS
         ‚ùå Failed: $FAILED_TESTS
         ‚ö†Ô∏è  Broken: $BROKEN_TESTS
         ‚è≠Ô∏è  Skipped: $SKIPPED_TESTS
         üìà Total: $TOTAL_TESTS
         üéØ Success Rate: $SUCCESS_RATE%

         üö® *Status:* $TESTS_STATUS

         üåê *Allure Report:*
         https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/

         üîó *Workflow Details:*
         https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

         üìù *Branch:* ${{ github.ref_name }}
         üè∑Ô∏è *Commit:* ${{ github.event.head_commit.message }}"
          
          # –ï—Å–ª–∏ —Ç–µ—Å—Ç–æ–≤ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
          if [ $TOTAL_TESTS -eq 0 ]; then
            TELEGRAM_MESSAGE="$TELEGRAM_MESSAGE

         üì¢ *–í–Ω–∏–º–∞–Ω–∏–µ:* –¢–µ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –æ—Ç—á–µ—Ç–∞—Ö!
         –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤."
          fi
          
          echo "$TELEGRAM_MESSAGE" > telegram_message.txt
          echo "–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ —Ñ–∞–π–ª"

      - name: Upload Allure report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30

      - name: Upload HTML report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-report
          path: report.html
          retention-days: 30

      - name: Deploy to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          force_orphan: true

      - name: Send Telegram notification
        if: always()
        run: |
          echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram..."
          
          # –ß–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞
          if [ -f "telegram_message.txt" ]; then
            MESSAGE=$(cat telegram_message.txt)
            echo "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ —Ñ–∞–π–ª–∞"
          else
            # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é
            echo "‚ö†Ô∏è –§–∞–π–ª telegram_message.txt –Ω–µ –Ω–∞–π–¥–µ–Ω"
            MESSAGE="‚ùì *Test Automation Report*

           üìä *Test Results:*
           ‚úÖ Passed: 0
           ‚ùå Failed: 0
           ‚ö†Ô∏è  Broken: 0
           ‚è≠Ô∏è  Skipped: 0
           üìà Total: 0
           üéØ Success Rate: 0%

            üö® *Status:* NO TESTS ‚ö†Ô∏è

           üåê *Allure Report:*
           https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/

          üîó *Workflow Details:*
           https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          üìù *Branch:* ${{ github.ref_name }}
          üè∑Ô∏è *Commit:* ${{ github.event.head_commit.message }}

          üì¢ *–í–Ω–∏–º–∞–Ω–∏–µ:* –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏!"
          fi
          
                 echo "–î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ${#MESSAGE} —Å–∏–º–≤–æ–ª–æ–≤"
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ curl
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview="true"
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram"
          fi

      - name: Show Report URLs
        if: always()
        run: |
          echo "üìä Allure Report URLs:"
          echo "1. GitHub Pages: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "2. Allure Artifact: Download from Actions artifacts after workflow completes"
          echo "3. HTML Report: Download from Actions artifacts (report.html)"
          echo "4. Telegram: Notification sent to your bot"
          echo ""
          echo "üìã Test Results –∏–∑ outputs:"
          echo "  Total: ${{ steps.stats.outputs.total_tests }}"
          echo "  Passed: ${{ steps.stats.outputs.passed_tests }}"
          echo "  Failed: ${{ steps.stats.outputs.failed_tests }}"
          echo "  Broken: ${{ steps.stats.outputs.broken_tests }}"
          echo "  Skipped: ${{ steps.stats.outputs.skipped_tests }}"
          echo "  Success Rate: ${{ steps.stats.outputs.success_rate }}%"